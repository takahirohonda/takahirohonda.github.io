"use strict";(self.webpackChunkmydatahack_blog_site=self.webpackChunkmydatahack_blog_site||[]).push([[2624],{77380:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>l,frontMatter:()=>a,metadata:()=>s,toc:()=>d});var o=n(74848),i=n(28453);const a={sidebar_position:6},r="Unit Testing Entity Framework Database Update logic with NSubstitute",s={id:"Web/DotNet/unit-test-n-substitute",title:"Unit Testing Entity Framework Database Update logic with NSubstitute",description:"In the previous post (UnitTesting ASP.NET Web API by Mocking DbContext with NSubstitute), we explored how to create a unit test for getting data from database with Entity Framework by mocking DbContext and DbSet. We are going to build upon the API we created previously and add PUT logic where it updates the Actor record in MySQL by actor_id.",source:"@site/docs/Web/DotNet/6.unit-test-n-substitute.md",sourceDirName:"Web/DotNet",slug:"/Web/DotNet/unit-test-n-substitute",permalink:"/mydatahack-old-blog/mydatahack-old-blog/Web/DotNet/unit-test-n-substitute",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"Quickest Way to Enable CORS for ASP.NET Core Web API application",permalink:"/mydatahack-old-blog/mydatahack-old-blog/Web/DotNet/enbale-cors"},next:{title:"Unit Testing ASP.NET Web API by Mocking DbContext with NSubstitute",permalink:"/mydatahack-old-blog/mydatahack-old-blog/Web/DotNet/dbcontext-mocking-n-substitute"}},c={},d=[];function u(t){const e={code:"code",h1:"h1",p:"p",pre:"pre",...(0,i.R)(),...t.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.h1,{id:"unit-testing-entity-framework-database-update-logic-with-nsubstitute",children:"Unit Testing Entity Framework Database Update logic with NSubstitute"}),"\n",(0,o.jsx)(e.p,{children:"In the previous post (UnitTesting ASP.NET Web API by Mocking DbContext with NSubstitute), we explored how to create a unit test for getting data from database with Entity Framework by mocking DbContext and DbSet. We are going to build upon the API we created previously and add PUT logic where it updates the Actor record in MySQL by actor_id."}),"\n",(0,o.jsx)(e.p,{children:"If you need to brush up on ASP.NET Web API fundamental,check out this post, simpleWeb API in 5 minutes. For the unit testing framework, we are using xUnitand NSubstitute."}),"\n",(0,o.jsx)(e.p,{children:"Check the complete API and unit testing solutions in our repo here."}),"\n",(0,o.jsx)(e.p,{children:"Creating PUT logic"}),"\n",(0,o.jsx)(e.p,{children:"To update database, we are going to use EntityState. To make this testable, we will create a MarkAsModified method insakilaContext.cs."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-csharp",children:"public void MarkAsModified(Actor item)\n{\n    Entry(item).State = EntityState.Modified;\n}\n"})}),"\n",(0,o.jsx)(e.p,{children:"Add it to the interface, IsakilaContext.cs. We also need to add SaveChange() method in the interface. This is to stub SaveChange() method."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-csharp",children:"int SaveChanges();\nvoid MarkAsModified(Actor actor);\n"})}),"\n",(0,o.jsx)(e.p,{children:"Then, add UpdateActor method to ActorsRepository. Check if the id exists in the database. If it does, update the record and return 1."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-csharp",children:'public int UpdateActorByIdEntityState(int id, Actor actor)\n{\n    int updateSuccess = 0;\n    if (id != actor.ActorId)\n    {\n        return updateSuccess;\n    }\n    _context.MarkAsModified(actor);\n    updateSuccess = _context.SaveChanges();\n    return updateSuccess;\n}\nController use this method for PUT request.\n\n[HttpPut("{id}")]\npublic IActionResult Put(int id, [FromBody]Actor actor)\n{\n    if(!ModelState.IsValid)\n    {\n        return BadRequest();\n    }\n\n    int success = actors.UpdateActorByIdEntityState(id, actor);\n\n    if (success == 1)\n    {\n        return Ok();\n    }\n    return BadRequest();\n}\n'})}),"\n",(0,o.jsx)(e.p,{children:"Creating Unit Test on Repository"}),"\n",(0,o.jsx)(e.p,{children:"Mocking DbSet and DbContext has been described in the previous post. Now, we can substitute the void method, MarkAsModified and SaveChange() method in the IsakilaContext."}),"\n",(0,o.jsx)(e.p,{children:"Rest is simple. There are four scenarios in the test. By substituting the void method to increment the counter every time it gets called, we can check how many times MarkAsModified method was called."}),"\n",(0,o.jsx)(e.p,{children:"Here is the Unit testing best practice guide for further reading."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-csharp",children:'namespace ApiMySQLActorUnitTest\n{\n    public class ActorsRepositoryTest\n    {\n        private MockActors _Actors;\n        private DbSet<Actor> _mockDbSet;\n        private IsakilaContext _mockSakilaContext;\n        private ActorsRepository _actors;\n\n        public ActorsRepositoryTest()\n        {\n            this._Actors = new MockActors();\n            this._mockDbSet = NSubstituteUtils.CreateMockDbSet(_Actors.Actors);\n            this._mockSakilaContext = Substitute.For<IsakilaContext>();\n            _mockSakilaContext.Actor.Returns(_mockDbSet);\n            this._actors = new ActorsRepository(_mockSakilaContext);\n        }\n\n        [Fact]\n        public void UpdateActorByIdEntityState_Should_Return_1_When_Actor_Exists_In_DB()\n        {\n            // Arrange\n            int id = 1;\n            Actor newActor = new Actor { ActorId = 1, FirstName = "Updated", LastName = "Actor", LastUpdate = DateTime.Now, FilmActor = new List<FilmActor>() };\n            var counter = 0;\n\n            // Act\n            _mockSakilaContext.When(x => x.MarkAsModified(newActor)).Do(x => counter++);\n            _mockSakilaContext.SaveChanges().Returns(1);\n            int success = _actors.UpdateActorByIdEntityState(id, newActor);\n\n            // Assert\n            success.Should().Be(1);\n        }\n\n        [Fact]\n        public void MarkAsModified_Method_Should_Be_Called_Once_When_Actor_Exists_In_DB()\n        {\n            // Arrange\n            int id = 1;\n            Actor newActor = new Actor { ActorId = 1, FirstName = "Updated", LastName = "Actor", LastUpdate = DateTime.Now, FilmActor = new List<FilmActor>() };\n            var counter = 0;\n\n            // Act\n            _mockSakilaContext.When(x => x.MarkAsModified(newActor)).Do(x => counter++);\n            _mockSakilaContext.SaveChanges().Returns(1);\n            int success = _actors.UpdateActorByIdEntityState(id, newActor);\n\n            // Assert\n            counter.Should().Be(1);\n        }\n\n        [Fact]\n        public void UpdateActorByIdEntityState_Should_Return_0_When_Actor_DoesnNot_Exist()\n        {\n            // Arrange\n            int id = 1;\n            Actor newActor = new Actor { ActorId = 100, FirstName = "Updated", LastName = "Actor", LastUpdate = DateTime.Now, FilmActor = new List<FilmActor>() };\n            var counter = 0;\n\n            // Act\n            _mockSakilaContext.When(x => x.MarkAsModified(newActor)).Do(x => counter++);\n            _mockSakilaContext.SaveChanges().Returns(1);\n            int success = _actors.UpdateActorByIdEntityState(id, newActor);\n\n            // Assert\n            success.Should().Be(0);\n        }\n\n        [Fact]\n        public void MarkAsModified_Should_Not_Execute_MarkAsModified_Method_When_Actor_DoesnNot_Exist()\n        {\n            // Arrange\n            int id = 1;\n            Actor newActor = new Actor { ActorId = 100, FirstName = "Updated", LastName = "Actor", LastUpdate = DateTime.Now, FilmActor = new List<FilmActor>() };\n            var counter = 0;\n\n            // Act\n            _mockSakilaContext.When(x => x.MarkAsModified(newActor)).Do(x => counter++);\n            _mockSakilaContext.SaveChanges().Returns(1);\n            int success = _actors.UpdateActorByIdEntityState(id, newActor);\n\n            // Assert\n            counter.Should().Be(0);\n        }\n    }\n}\n'})}),"\n",(0,o.jsx)(e.p,{children:"(2018-12-12)"})]})}function l(t={}){const{wrapper:e}={...(0,i.R)(),...t.components};return e?(0,o.jsx)(e,{...t,children:(0,o.jsx)(u,{...t})}):u(t)}},28453:(t,e,n)=>{n.d(e,{R:()=>r,x:()=>s});var o=n(96540);const i={},a=o.createContext(i);function r(t){const e=o.useContext(a);return o.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function s(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(i):t.components||i:r(t.components),o.createElement(a.Provider,{value:e},t.children)}}}]);
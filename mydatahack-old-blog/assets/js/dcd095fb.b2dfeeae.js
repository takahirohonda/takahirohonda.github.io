"use strict";(self.webpackChunkmydatahack_blog_site=self.webpackChunkmydatahack_blog_site||[]).push([[1906],{83500:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>h,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var s=n(74848),r=n(28453);const o={sidebar_position:5},a="Handling Authorisation With Apollo",i={id:"Web/Node.js/auth-with-apollo-server",title:"Handling Authorisation With Apollo",description:"There are many ways to handle authorisation with Apollo. Authorisation is the process to determine if the authenticated user has access rights for the particular resources while authentication is to confirm the user\u2019s identity.",source:"@site/docs/Web/Node.js/5.auth-with-apollo-server.md",sourceDirName:"Web/Node.js",slug:"/Web/Node.js/auth-with-apollo-server",permalink:"/mydatahack-old-blog/docs/Web/Node.js/auth-with-apollo-server",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"TypeORM vs Prisma to build GraphQL APIs with TypeScript",permalink:"/mydatahack-old-blog/docs/Web/Node.js/typeORM-prisma-graphql"},next:{title:"Node.js Libraries for Protecting GraphQL APIs",permalink:"/mydatahack-old-blog/docs/Web/Node.js/protect-graphql-api-node"}},h={},l=[];function c(e){const t={a:"a",code:"code",h1:"h1",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"handling-authorisation-with-apollo",children:"Handling Authorisation With Apollo"}),"\n",(0,s.jsx)(t.p,{children:"There are many ways to handle authorisation with Apollo. Authorisation is the process to determine if the authenticated user has access rights for the particular resources while authentication is to confirm the user\u2019s identity."}),"\n",(0,s.jsx)(t.p,{children:"In short, my recommendation is (5), by using graphql-shield. You can also check the code example for handling authorisation with graphql-shield here."}),"\n",(0,s.jsx)(t.p,{children:"(1) Implementing Authorisation in a Resolver"}),"\n",(0,s.jsx)(t.p,{children:"This is the simplest way, but not very scalable. As an example, we can pass a user object in the context. By using the information about the user\u2019s role, we can write an if-else condition."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:'movie: (parent, arg, { user, dataSources }, info) => {\n  if (user && user.role === "ADMIN") {\n    return dataSources.getMovies();\n  }\n};\n'})}),"\n",(0,s.jsx)(t.p,{children:"(2) Implementing Authorisation in a Model"}),"\n",(0,s.jsx)(t.p,{children:"Create a model and control data access. The below example is to check the user role and can query any user if the role is set to ADMIN and can only query their own data if the role is set to USER. It\u2019s cool, but convoluted in my opinion."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import { getUserById } from '../datasources/user';\n\nconst userModel = ({ user }) => {\n  return (\n    getById: (id) => {\n      if (user) {\n        if (user.role === 'ADMIN') {\n          return getUserById(id);\n        }\n        if (user.role === 'USER') {\n          return getUserById(user.id);\n        }\n      }\n    }\n  )\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"Then, we can pass this in the context\u2019s return value where you do new ApolloServer(). This can be used in the repository method."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"return (\n  user,\n  otherThings,\n  models: {\n    User: generateUserModel({ user })\n  }\n)\n"})}),"\n",(0,s.jsx)(t.p,{children:"(3) Using Schema Directive"}),"\n",(0,s.jsx)(t.p,{children:"We can create a custom schema directive as in the documentation here."}),"\n",(0,s.jsx)(t.p,{children:"(4) Wrap a resolver function with graphql-auth"}),"\n",(0,s.jsx)(t.p,{children:"We can use the node module, graphql-auth, to wrap the resolver function as below. It\u2019s pretty nice."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import withAuth from 'graphql-auth';\n\nconst resolvers = {\n  Query: {\n    users: withAuth(['users:view'], (root, args, context) => { ... }),\n    ...\n  }\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"(5) Use graphql-shield"}),"\n",(0,s.jsx)(t.p,{children:"This is the recommended way to handle authorisation with Apollo. graphql-shield can completely abstract the authentication from the resolver. It is the cleanest and easiest way to handle authorisation. Because the permission rules are abstracted, it is easy to manage when the app starts scaling up. It works well with Apollo Federation, too."}),"\n",(0,s.jsxs)(t.p,{children:["See my code example of using graphql-shield to handle authorisation ",(0,s.jsx)(t.a,{href:"https://github.com/mydatahack/javascript-projects/tree/master/Apollo-Auth-Ts",children:"here"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"(2021-05-20)"})]})}function d(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>i});var s=n(96540);const r={},o=s.createContext(r);function a(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);
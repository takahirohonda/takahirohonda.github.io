"use strict";(self.webpackChunkmydatahack_blog_site=self.webpackChunkmydatahack_blog_site||[]).push([[7882],{99136:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>d,contentTitle:()=>s,default:()=>g,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var o=t(74848),r=t(28453);const a={sidebar_position:4},s="How to Ingest Data Into MongoDB with Node.js",i={id:"data-ingestion/mongo-node-1",title:"How to Ingest Data Into MongoDB with Node.js",description:"Now that we got data from MongoDB and loaded into Postgres with some transformation, let\u2019s put the data back into MongoDB. This post is the continuation of the previous post about ingesting data from MongoDB. You should totally start from How to Ingest Data From MongoDB with Node.js.",source:"@site/docs/data-ingestion/4.mongo-node-1.md",sourceDirName:"data-ingestion",slug:"/data-ingestion/mongo-node-1",permalink:"/mydatahack-old-blog/docs/data-ingestion/mongo-node-1",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Uploading and Downloading Files in S3 with Node.js",permalink:"/mydatahack-old-blog/docs/data-ingestion/s3-data-node-2"},next:{title:"How to Ingest Data From MongoDB with Node.js",permalink:"/mydatahack-old-blog/docs/data-ingestion/mong-node-2"}},d={},c=[];function l(n){const e={code:"code",h1:"h1",p:"p",pre:"pre",...(0,r.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.h1,{id:"how-to-ingest-data-into-mongodb-with-nodejs",children:"How to Ingest Data Into MongoDB with Node.js"}),"\n",(0,o.jsx)(e.p,{children:"Now that we got data from MongoDB and loaded into Postgres with some transformation, let\u2019s put the data back into MongoDB. This post is the continuation of the previous post about ingesting data from MongoDB. You should totally start from How to Ingest Data From MongoDB with Node.js."}),"\n",(0,o.jsx)(e.p,{children:"The aim is simple. We are going to get the data from the two tables, restaurants and grades (which were originally created here with Python or here with Node.js), reconstruct original JSON structures and load it back to MongoDB."}),"\n",(0,o.jsx)(e.p,{children:"The transformation is a little bit more interesting because we have to wrangle normalised tables back into the original JSON format."}),"\n",(0,o.jsx)(e.p,{children:"Let\u2019s start with putting the JSON back together."}),"\n",(0,o.jsx)(e.p,{children:"joinRestaurants.js"}),"\n",(0,o.jsx)(e.p,{children:"Creating the array with grades aggregated per unique id from the tabular table format is challenging. There may be a better way than using two for loops because for loops are notoriously slow. It works at least."}),"\n",(0,o.jsx)(e.p,{children:"To rearrange the main table, I used the node-json-transform module. For any simple JSON wrangling, I always use it because it is simple to use. I don\u2019t think the module does the transformation required for the grades table, though."}),"\n",(0,o.jsx)(e.p,{children:"In the end, the two JSON objects are joined by the common key (_id)."}),"\n",(0,o.jsx)(e.p,{children:"The function takes the parent and child (which means restaurants and grades) JSON object as argument parameters. We will export this module."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:'const DataTransform = require("node-json-transform").DataTransform;\n\nconst transformTables = (parent, child) => {\n  console.log("Start join operation");\n  // function to transform Grades\n  const transformGrades = (data) => {\n    // Get unique id\n    var idArray = Array.from(new Set(data.map((x) => x.id)));\n\n    // Set arrays\n    var final = new Array();\n\n    // Aggregate grade array per unique id\n    for (const i in idArray) {\n      var id = idArray[i];\n      var tmpGrade = new Array();\n      // Find the records in grades with the unique id and create grades array per id.\n      for (const index in data) {\n        var record = data[index];\n        if (data[index].id == id) {\n          tmpGrade.push({\n            date: record.date,\n            grade: record.grade,\n            score: record.score,\n          });\n        }\n      }\n      final.push({ _id: id, grades: tmpGrade });\n    }\n    return final;\n  };\n\n  // function to transform Restaurants Main Table\n  const transformRestaurants = (data) => {\n    // Using node-json-transform\n    var map = {\n      list: "",\n      item: {\n        _id: "id",\n        address: {\n          building: "address_building",\n          coord: ["address_coord1", "address_coord2"],\n          street: "address_street",\n          zipcode: "address_zipcode",\n        },\n        borough: "address_borough",\n        cuisine: "cuisine",\n        name: "name",\n        restaurant_id: "restaurant_id",\n      },\n    };\n    var dataTransform = DataTransform(data, map);\n    var results = dataTransform.transform();\n    return results;\n  };\n\n  var gradesT = transformGrades(child);\n  var restaurants = transformRestaurants(parent);\n\n  // Join grades array to restaurants by _id\n  for (const i in restaurants) {\n    var targetId = restaurants[i]._id;\n    var tmp = gradesT.filter((gradesT) => gradesT._id === targetId);\n    // console.log(\'target grades: \', JSON.stringify(tmp[0].grades))\n    if (tmp[0]) {\n      restaurants[i]["grades"] = tmp[0].grades;\n    }\n  }\n  console.log("Completed the data transformation");\n  console.log("Example Data:\\n", JSON.stringify(restaurants[0], null, 4));\n  return restaurants;\n};\n// Export the module\nmodule.exports = transformTables;\n'})}),"\n",(0,o.jsx)(e.p,{children:"mongoLoad.js"}),"\n",(0,o.jsx)(e.p,{children:"This is a straight forward function that takes database name, collection name and JSON object as parameters. It truncate the collection first and load the data. The connection details are imported as in the previous post."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:'const { MongoClient } = require("mongodb");\nconst config = require("./config/config.json");\nconst url = config.mongoConnection;\n\nconst mongoLoad = (dbName, collectionName, data) => {\n  console.log("Connecting to MongoDB...");\n  MongoClient.connect(url, (error, client) => {\n    var db = client.db(dbName);\n    var collection = db.collection(collectionName);\n    collection.remove({}, (err, results) => {\n      if (err) {\n        console.error(err);\n        process.exit(1);\n      }\n      console.log(`Truncated with ${results.result.n} rows.`);\n      collection.insert(data, (err, results) => {\n        if (err) {\n          console.error(err);\n          process.exit(1);\n        }\n        console.log(`Inserted records with ${results.result.n} rows.`);\n        client.close();\n        console.log("Connection closed");\n      });\n    });\n  });\n};\n\nmodule.exports = mongoLoad;\n'})}),"\n",(0,o.jsx)(e.p,{children:"main.js"}),"\n",(0,o.jsx)(e.p,{children:"Now everything comes together. In the main file, it queries two tables and pass the results to the join function. Once the data is joined, it gets passed to the data load function. The db connection details are imported as in the previous post."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:'const { Client } = require("pg");\nconst fs = require("fs");\nconst config = require("./config/config.json");\nconst transformTables = require("./joinRestaurants.js");\nconst mongoLoad = require("./mongoLoad.js");\n\nconst client = new Client({\n  user: config.pgUser,\n  host: config.pgHost,\n  database: config.pgDbname,\n  password: config.pgPw,\n  port: config.pgPort,\n});\n\nclient.connect();\nconsole.log("Connected to database.");\n\nconst queryMain = "Select * From mongodb.restaurants";\nconst queryGrades = "Select * From mongodb.grades";\nvar main;\nvar grades;\n\nconst query1 = (callback) => {\n  client.query(queryMain, (err, data) => {\n    if (err) {\n      console.error(err);\n      process.exit(1);\n    }\n    //fs.writeFileSync(\'./data/rest.json\', JSON.stringify(data.rows, null, 4))\n    //console.log(\'Created json file\')\n    main = data.rows;\n    callback();\n  });\n};\n\nconst query2 = (callback) => {\n  client.query(queryGrades, (err, data) => {\n    if (err) {\n      console.error(err);\n      process.exit(1);\n    }\n    // fs.writeFileSync(\'./data/grades.json\', JSON.stringify(data.rows, null, 4))\n    // console.log(\'Created json file 2\')\n    grades = data.rows;\n    callback();\n  });\n};\n\nquery1(() => {\n  query2(() => {\n    client.end();\n    console.log(JSON.stringify(main[0]));\n    console.log(JSON.stringify(grades[0]));\n    console.log("Connection closed");\n    var records = transformTables(main, grades);\n    mongoLoad("test", "restaurants2", records);\n  });\n});\n'})}),"\n",(0,o.jsx)(e.p,{children:"(2018-05-09)"})]})}function g(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(l,{...n})}):l(n)}},28453:(n,e,t)=>{t.d(e,{R:()=>s,x:()=>i});var o=t(96540);const r={},a=o.createContext(r);function s(n){const e=o.useContext(a);return o.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:s(n.components),o.createElement(a.Provider,{value:e},n.children)}}}]);